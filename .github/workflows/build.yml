name: Build Telegram macOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install dependencies
      run: |
        brew install cmake ninja openssl@1.1 zlib autoconf libtool automake yasm pkg-config nasm meson
    
    - name: Download Metal Toolchain
      run: |
        echo "Downloading Metal Toolchain..."
        xcodebuild -downloadComponent MetalToolchain || echo "Metal Toolchain download failed, continuing..."
    
    - name: Cache build artifacts
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Caches/Homebrew
          ./core-xprojects
        key: ${{ runner.os }}-build-${{ hashFiles('scripts/configure_frameworks.sh') }}
        restore-keys: |
          ${{ runner.os }}-build-
    
    - name: Configure frameworks
      run: |
        # 设置环境变量
        export MACOSX_DEPLOYMENT_TARGET=10.13
        
        # 确保必要的目录存在
        mkdir -p "./submodules/telegram-ios/submodules/TelegramCore/FlatSerialization/Sources"
        
        # 修复 Sparkle 子模块的 InfoPlist.strings 问题
        SPARKLE_STRINGS="./submodules/Sparkle/TestApplication/he.lproj/InfoPlist.strings"
        if [ ! -f "$SPARKLE_STRINGS" ]; then
          echo "Creating missing Sparkle InfoPlist.strings file..."
          mkdir -p "$(dirname "$SPARKLE_STRINGS")"
          touch "$SPARKLE_STRINGS"
        fi
        
        # 检查是否需要重新编译框架
        if [ ! -d "./core-xprojects/OpenH264/build" ]; then
          echo "Frameworks not found, building..."
          echo "yes" > ./scripts/rebuild
          
          # 运行配置脚本
          sh ./scripts/configure_frameworks.sh 2>&1 | tee framework_build.log || {
            echo "Framework build failed, showing last 50 lines:"
            tail -n 50 framework_build.log
            echo "Trying to continue anyway..."
          }
        else
          echo "Using cached frameworks"
          echo "no" > ./scripts/rebuild
        fi
    
    - name: Build with Xcode
      run: |
        set -o pipefail
        
        # 列出所有可用的 schemes
        echo "Available schemes:"
        xcodebuild -workspace Telegram-Mac.xcworkspace -list
        
        # 使用 App Store 配置来跳过 Sparkle
        echo "Building with App Store configuration (skips Sparkle)..."
        
        xcodebuild -workspace Telegram-Mac.xcworkspace \
                   -scheme "Telegram" \
                   -configuration "App Store" \
                   -derivedDataPath ./build \
                   -allowProvisioningUpdates \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   ONLY_ACTIVE_ARCH=NO \
                   MACOSX_DEPLOYMENT_TARGET=10.13 \
                   SKIP_INSTALL=YES \
                   ENABLE_BITCODE=NO \
                   MTL_ENABLE_DEBUG_INFO=NO \
                   MTLLINKER_FLAGS="" \
                   -skipPackagePluginValidation \
                   -skipMacroValidation \
                   clean build 2>&1 | tee xcodebuild.log | xcpretty || {
          echo "Build failed, showing errors:"
          grep -A 5 "error:" xcodebuild.log || tail -n 100 xcodebuild.log
          exit 1
        }
    
    - name: Create DMG (optional)
      if: success()
      run: |
        APP_PATH="./build/Build/Products/Release/Telegram.app"
        if [ -d "$APP_PATH" ]; then
          hdiutil create -volname "Telegram" \
                         -srcfolder "$APP_PATH" \
                         -ov -format UDZO \
                         "Telegram-macOS.dmg"
        fi
    
    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Telegram-macOS
        path: |
          ./build/Build/Products/Release/Telegram.app
          Telegram-macOS.dmg
        retention-days: 30
    
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          framework_build.log
          xcodebuild.log
        retention-days: 7
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Telegram-macOS.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
