name: Build Telegram macOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 180  # 增加超时到 3 小时
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install dependencies
      run: |
        brew install cmake ninja openssl@1.1 zlib autoconf libtool automake yasm pkg-config nasm meson
    
    - name: Download Metal Toolchain
      run: |
        echo "Downloading Metal Toolchain..."
        xcodebuild -downloadComponent MetalToolchain || echo "Metal Toolchain download failed, continuing..."
    
    - name: Cache build artifacts
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Caches/Homebrew
          ./core-xprojects
          ./submodules/tgcalls/SharedHeaders
        key: ${{ runner.os }}-frameworks-${{ hashFiles('scripts/configure_frameworks.sh') }}
        restore-keys: |
          ${{ runner.os }}-frameworks-
          ${{ runner.os }}-build-
    
    - name: Configure frameworks
      run: |
        # 设置环境变量
        export MACOSX_DEPLOYMENT_TARGET=10.13
        
        # 检查是否已有预构建的框架（从缓存或仓库）
        if [ -d "./submodules/tgcalls/SharedHeaders/webrtc" ] && [ -d "./core-xprojects/webrtc/build" ]; then
          echo "✓ Pre-built frameworks found in cache, skipping framework build"
          echo "no" > ./scripts/rebuild
          exit 0
        fi
        
        echo "Frameworks not found, need to build from source..."
        echo "This will take 1-2 hours and may fail due to complexity."
        
        # 修复 mozjpeg CMake 版本问题
        echo "Fixing mozjpeg CMakeLists.txt..."
        MOZJPEG_CMAKE="./submodules/telegram-ios/third-party/mozjpeg/mozjpeg/CMakeLists.txt"
        if [ -f "$MOZJPEG_CMAKE" ]; then
          sed -i '' 's/cmake_minimum_required(VERSION 2.8.12)/cmake_minimum_required(VERSION 3.5)/' "$MOZJPEG_CMAKE"
          echo "mozjpeg CMakeLists.txt fixed"
        fi
        
        # 修复 FFmpeg
        echo "Fixing FFmpeg version..."
        sed -i '' 's/FF_VERSION="7.1"/FF_VERSION="7.1.1"/' core-xprojects/ffmpeg/ffmpeg/build.sh
        
        # 修复 tg_owt 子模块未初始化的可能
        echo "Initializing nested WebRTC submodules..."
        cd submodules/tg_owt
        git submodule update --init --recursive
        cd ../..
      
        # 确保必要的目录存在
        mkdir -p "./submodules/telegram-ios/submodules/TelegramCore/FlatSerialization/Sources"
        
        # 按照官方文档步骤 4: 设置 rebuild 为 yes（强制重新构建所有框架）
        echo "yes" > ./scripts/rebuild
        
        # 按照官方文档步骤 5: 运行配置脚本构建所有框架（包括 WebRTC）
        echo "Building frameworks (this will take 1-2 hours)..."
        sh ./scripts/configure_frameworks.sh 2>&1 | tee framework_build.log || {
          echo "WARNING: Framework build had errors, checking what succeeded..."
          echo "Showing last 300 lines of build log:"
          tail -n 300 framework_build.log
        }
        
        # 检查关键框架是否构建成功
        echo "Checking built frameworks..."
        ls -la ./core-xprojects/*/build/ 2>&1 || echo "No framework builds found"
        
        if [ ! -d "./submodules/tgcalls/SharedHeaders/webrtc" ]; then
          echo "ERROR: WebRTC headers not found after framework build!"
          echo "This means configure_frameworks.sh failed to build WebRTC."
          echo "The build will likely fail."
          exit 1
        else
          echo "✓ WebRTC headers found"
        fi
        
        echo "Framework build step completed"
    
    - name: Build with Xcode
      run: |
        set -o pipefail
        
        # 列出所有可用的 schemes
        echo "Available schemes:"
        xcodebuild -workspace Telegram-Mac.xcworkspace -list
        
        # 使用 App Store 配置来跳过 Sparkle
        echo "Building with App Store configuration (skips Sparkle)..."
        
        xcodebuild -workspace Telegram-Mac.xcworkspace \
                   -scheme "Telegram" \
                   -configuration "App Store" \
                   -derivedDataPath ./build \
                   -allowProvisioningUpdates \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   ONLY_ACTIVE_ARCH=NO \
                   MACOSX_DEPLOYMENT_TARGET=10.13 \
                   SKIP_INSTALL=YES \
                   ENABLE_BITCODE=NO \
                   MTL_ENABLE_DEBUG_INFO=NO \
                   MTLLINKER_FLAGS="" \
                   SWIFT_ENABLE_EXPLICIT_MODULES=NO \
                   -skipPackagePluginValidation \
                   -skipMacroValidation \
                   clean build 2>&1 | tee xcodebuild.log | xcpretty || {
          echo "Build failed, showing errors:"
          grep -A 5 "error:" xcodebuild.log || tail -n 100 xcodebuild.log
          exit 1
        }
    
    - name: Create DMG (optional)
      if: success()
      run: |
        APP_PATH="./build/Build/Products/Release/Telegram.app"
        if [ -d "$APP_PATH" ]; then
          hdiutil create -volname "Telegram" \
                         -srcfolder "$APP_PATH" \
                         -ov -format UDZO \
                         "Telegram-macOS.dmg"
        fi
    
    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Telegram-macOS
        path: |
          ./build/Build/Products/Release/Telegram.app
          Telegram-macOS.dmg
        retention-days: 30
    
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          framework_build.log
          xcodebuild.log
        retention-days: 7
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Telegram-macOS.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
